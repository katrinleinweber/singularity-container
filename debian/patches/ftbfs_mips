Description: Fix FTBFS on mips*
Author: James Cowgill <jcowgill@debian.org>
Last-Update: 2017-12-04
Bug-Debian: https://bugs.debian.org/883466

--- a/src/util/setns.c
+++ b/src/util/setns.c
@@ -23,7 +23,29 @@
 
 #if defined (SINGULARITY_NO_SETNS) && defined (SINGULARITY_SETNS_SYSCALL)
 
-#include "util/setns.h"
+#ifndef __NR_setns
+#  if defined (__x86_64__)
+#    define __NR_setns 308
+#  elif defined (__i386__)
+#    define __NR_setns 346
+#  elif defined (__alpha__)
+#    define __NR_setns 501
+#  elif defined (__arm__)
+#    define __NR_setns 375
+#  elif defined (__aarch64__)
+#    define __NR_setns 375
+#  elif defined (__ia64__)
+#    define __NR_setns 1330
+#  elif defined (__sparc__)
+#    define __NR_setns 337
+#  elif defined (__powerpc__)
+#    define __NR_setns 350
+#  elif defined (__s390__)
+#    define __NR_setns 339
+#  else
+#    error Please determine the syscall number for setns on your architecture
+#  endif
+#endif
 
 int setns(int fd, int nstype) {
     singularity_message(DEBUG, "Using syscall() wrapped __NR_setns\n");
--- a/src/util/setns.h
+++ b/src/util/setns.h
@@ -16,34 +16,6 @@
 #ifndef __SETNS_H_
 #define __SETNS_H_
 
-#ifndef __NR_setns
-#  if defined (__x86_64__)
-#    define __NR_setns 308
-#  elif defined (__i386__)
-#    define __NR_setns 346
-#  elif defined (__alpha__)
-#    define __NR_setns 501
-#  elif defined (__arm__)
-#    define __NR_setns 375
-#  elif defined (__aarch64__)
-#    define __NR_setns 375
-#  elif defined (__ia64__)
-#    define __NR_setns 1330
-#  elif defined (__sparc__)
-#    define __NR_setns 337
-#  elif defined (__powerpc__)
-#    define __NR_setns 350
-#  elif defined (__s390__)
-#    define __NR_setns 339
-#  endif
-#endif
-
-#ifdef __NR_setns
-
 extern int setns(int fd, int nstype);
 
-#else /* !__NR_setns */
-#  error Please determine the syscall number for setns on your architecture
-#endif
-
 #endif /* __SETNS_H_ */
--- a/src/util/signal.c
+++ b/src/util/signal.c
@@ -36,7 +36,9 @@
     SIGPIPE,
     SIGALRM,
     SIGTERM,
+#ifdef SIGSTKFLT
     SIGSTKFLT,
+#endif
     SIGCHLD,
     SIGCONT,
     SIGTSTP,
